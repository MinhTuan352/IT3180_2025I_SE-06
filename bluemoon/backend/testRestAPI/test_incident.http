@baseUrl = http://localhost:3000/api
@contentType = application/json

# ==================================================================
# PHẦN 1: ĐĂNG NHẬP ĐỂ LẤY TOKEN
# ==================================================================

# 1. Đăng nhập Admin (BOD)
# @name loginAdmin
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
    "username": "admin.a",
    "password": "password123"
}

###
@tokenAdmin = {{loginAdmin.response.body.data.accessToken}}


# 2. Đăng nhập Cư dân (Resident)
# @name loginResident
POST {{baseUrl}}/auth/login
Content-Type: {{contentType}}

{
    "username": "chuho_a101",
    "password": "password123"
}

###
@tokenResident = {{loginResident.response.body.data.accessToken}}


# ==================================================================
# PHẦN 2: CƯ DÂN BÁO CÁO SỰ CỐ
# ==================================================================

### 3. Cư dân gửi báo cáo sự cố (Multipart)
# Lưu ý: Nếu không có file ảnh thật, bạn có thể xóa phần hình ảnh đi, 
# Backend vẫn chấp nhận nếu không bắt buộc file.
POST {{baseUrl}}/incidents
Authorization: Bearer {{tokenResident}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryIncident

------WebKitFormBoundaryIncident
Content-Disposition: form-data; name="title"

Vòi nước bồn rửa bát bị rò rỉ
------WebKitFormBoundaryIncident
Content-Disposition: form-data; name="description"

Nước chảy nhỏ giọt suốt đêm, van khóa bị lỏng.
------WebKitFormBoundaryIncident
Content-Disposition: form-data; name="location"

Căn hộ A-101, Bếp
------WebKitFormBoundaryIncident
Content-Disposition: form-data; name="priority"

Trung bình
------WebKitFormBoundaryIncident--

###
# [QUAN TRỌNG]: Hãy copy ID của sự cố vừa tạo từ response trên và dán vào biến dưới đây
@incidentId = SCxxxxx


# ==================================================================
# PHẦN 3: ADMIN XỬ LÝ (QUY TRÌNH SPRINT 2)
# ==================================================================

### 4. Admin xem danh sách sự cố (Lọc những cái Mới)
GET {{baseUrl}}/incidents?status=Mới
Authorization: Bearer {{tokenAdmin}}

### 5. Admin tiếp nhận và chuyển trạng thái "Đang xử lý"
# - Gán cho nhân viên (assigned_to)
# - Cập nhật phản hồi (admin_response)
PUT {{baseUrl}}/incidents/{{incidentId}}
Authorization: Bearer {{tokenAdmin}}
Content-Type: {{contentType}}

{
    "status": "Đang xử lý",
    "assigned_to": "ID0001",
    "priority": "Cao",
    "admin_response": "Đã tiếp nhận. Kỹ thuật viên sẽ lên kiểm tra trong 30 phút nữa."
}

### 6. Admin hoàn thành xử lý
# Khi status = 'Hoàn thành', hệ thống sẽ tự động set completed_at = NOW()
PUT {{baseUrl}}/incidents/{{incidentId}}
Authorization: Bearer {{tokenAdmin}}
Content-Type: {{contentType}}

{
    "status": "Hoàn thành",
    "admin_response": "Đã thay van khóa mới. Kiểm tra không còn rò rỉ."
}


# ==================================================================
# PHẦN 4: CƯ DÂN ĐÁNH GIÁ (FEEDBACK)
# ==================================================================

### 7. Cư dân xem chi tiết sự cố (Để thấy phản hồi của Admin)
GET {{baseUrl}}/incidents/{{incidentId}}
Authorization: Bearer {{tokenResident}}


### 8. Cư dân đánh giá chất lượng (Rating & Feedback)
# Điều kiện: Status phải là 'Hoàn thành' mới được gọi API này
PUT {{baseUrl}}/incidents/{{incidentId}}
Authorization: Bearer {{tokenResident}}
Content-Type: {{contentType}}

{
    "rating": 5,
    "feedback": "Cảm ơn BQL, bác kỹ thuật làm việc rất nhanh và sạch sẽ."
}


### 9. Test lỗi: Cư dân cố tình sửa trạng thái (Sẽ bị chặn hoặc lờ đi)
# Logic Backend: Nếu là Resident, chỉ update rating/feedback, các field status sẽ bị bỏ qua
PUT {{baseUrl}}/incidents/{{incidentId}}
Authorization: Bearer {{tokenResident}}
Content-Type: {{contentType}}

{
    "status": "Mới" 
}